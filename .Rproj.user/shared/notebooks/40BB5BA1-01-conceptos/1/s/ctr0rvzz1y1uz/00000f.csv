"0","#Descomposición de la varianza HISTÓRICA"
"0","##FUNCIONES"
"0","VARhd <- function(Estimation){"
"0","  ## make X and Y"
"0","  nlag    <- Estimation$p   # number of lags"
"0","  DATA    <- Estimation$y   # data"
"0","  QQ      <- VARmakexy(DATA,nlag,1)"
"0","  #invA   <- t(chol(as.matrix(summary(Estimation)$covres)))# inverse of the A matrix"
"0","  invA    <- BQMODEL$LRIM"
"0","  #invA   <- bqfactor"
"0","  Fcomp   <- companionmatrix(Estimation)                   # Companion matrix"
"0","  #det    <- c_case                                       # constant and/or trends"
"0","  F1      <- t(QQ$Ft)                                     # make comparable to notes"
"0","  eps     <- ginv(invA) %*% t(residuals(Estimation))"
"0","  # structural errors"
"0","  nvar    <- Estimation$K                                 # number of endogenous variables"
"0","  nvarXeq <- nvar * nlag                                  # number of lagged endogenous per equation"
"0","  nvar_ex <- 0                                                # number of exogenous (excluding constant and trend)"
"0","  Y       <- QQ$Y                                             # left-hand side"
"0","  #X     <- QQ$X[,(1+det):(nvarXeq+det)]                    # right-hand side (no exogenous)"
"0","  nobs    <- nrow(Y)                                          # number of observations"
"0","  ## Compute historical decompositions"
"0","  # Contribution of each shock"
"0","  invA_big    <- matrix(0,nvarXeq,nvar)"
"0","  invA_big[1:nvar,] <- invA"
"0","  Icomp       <- cbind(diag(nvar), matrix(0,nvar,(nlag-1)*nvar))"
"0","  HDshock_big <- array(0, dim=c(nlag*nvar,nobs+1,nvar))"
"0","  HDshock     <- array(0, dim=c(nvar,(nobs+1),nvar))"
"0",""
"0","  for (j in 1:nvar){  # for each variable"
"0","    eps_big <- matrix(0,nvar,(nobs+1)) # matrix of shocks conformable with companion"
"0","    eps_big[j,2:ncol(eps_big)] <- eps[j,]"
"0","    for (i in 2:(nobs+1)){"
"0","      HDshock_big[,i,j] <- invA_big %*% eps_big[,i] + Fcomp %*% HDshock_big[,(i-1),j]"
"0","      HDshock[,i,j] <-  Icomp %*% HDshock_big[,i,j]"
"0","    }"
"0","  }"
"0",""
"0","  HD.shock <- array(0, dim=c((nobs+nlag),nvar,nvar))   # [nobs x shock x var]"
"0",""
"0","  for (i in 1:nvar){"
"0","    for (j in 1:nvar){"
"0","      HD.shock[,j,i] <- c(rep(NA,nlag), HDshock[i,(2:dim(HDshock)[2]),j])"
"0","    }"
"0","  }"
"0",""
"0","  return(HD.shock)"
"0",""
"0","}"
"0","##########"
"0","VARmakexy <- function(DATA,lags,c_case){"
"0","  nobs <- nrow(DATA)"
"0","  #Y matrix"
"0","  Y <- DATA[(lags+1):nrow(DATA),]"
"0","  Y <- DATA[-c(1:lags),]"
"0","  #X-matrix"
"0","  if (c_case==0){"
"0","    X <- NA"
"0","    for (jj in 0:(lags-1)){"
"0","      X <- rbind(DATA[(jj+1):(nobs-lags+jj),])"
"0","    }"
"0","  } else if(c_case==1){ #constant"
"0","    X <- NA"
"0","    for (jj in 0:(lags-1)){"
"0","      X <- rbind(DATA[(jj+1):(nobs-lags+jj),])"
"0","    }"
"0","    X <- cbind(matrix(1,(nobs-lags),1), X)"
"0","  } else if(c_case==2){ # time trend and constant"
"0","    X <- NA"
"0","    for (jj in 0:(lags-1)){"
"0","      X <- rbind(DATA[(jj+1):(nobs-lags+jj),])"
"0","    }"
"0","    trend <- c(1:nrow(X))"
"0","    X <-cbind(matrix(1,(nobs-lags),1), t(trend))"
"0","  }"
"0","  A <- (t(X) %*% as.matrix(X))"
"0","  B <- (as.matrix(t(X)) %*% as.matrix(Y))"
"0",""
"0","  Ft <- ginv(A) %*% B"
"0","  retu <- list(X=X,Y=Y, Ft=Ft)"
"0","  return(retu)"
"0","}"
"0",""
"0","companionmatrix <- function (x)"
"0","{"
"0","  if (!(class(x) == ""varest"")) {"
"0","    stop(""\nPlease provide an object of class 'varest', generated by 'VAR()'.\n"")"
"0","  }"
"0","  K <- x$K"
"0","  p <- x$p"
"0","  A <- unlist(Acoef(x))"
"0","  companion <- matrix(0, nrow = K * p, ncol = K * p)"
"0","  companion[1:K, 1:(K * p)] <- A"
"0","  if (p > 1) {"
"0","    j <- 0"
"0","    for (i in (K + 1):(K * p)) {"
"0","      j <- j + 1"
"0","      companion[i, j] <- 1"
"0","    }"
"0","  }"
"0","  return(companion)"
"0","}"
